{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/SSAFY/Desktop/panaxtos/front/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient };\r\n\r\nexport const prisma =\r\n    globalForPrisma.prisma ||\r\n    new PrismaClient({\r\n        log: ['query'],\r\n        datasourceUrl: process.env.DATABASE_URL || 'file:./dev.db'\r\n    });\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,SACT,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACb,KAAK;QAAC;KAAQ;IACd,eAAe,QAAQ,GAAG,CAAC,YAAY,IAAI;AAC/C;AAEJ,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 103, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/SSAFY/Desktop/panaxtos/front/lib/jwt.ts"],"sourcesContent":["import jwt from 'jsonwebtoken';\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'default-secret-key';\r\n\r\nexport function generateToken(username: string): string {\r\n    return jwt.sign({ username }, JWT_SECRET, { expiresIn: '7d' });\r\n}\r\n\r\nexport function verifyToken(token: string): { username: string } | null {\r\n    try {\r\n        return jwt.verify(token, JWT_SECRET) as { username: string };\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nexport function getTokenFromRequest(authHeader: string | null): string | null {\r\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\r\n        return null;\r\n    }\r\n    return authHeader.substring(7);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEtC,SAAS,cAAc,QAAgB;IAC1C,OAAO,kJAAG,CAAC,IAAI,CAAC;QAAE;IAAS,GAAG,YAAY;QAAE,WAAW;IAAK;AAChE;AAEO,SAAS,YAAY,KAAa;IACrC,IAAI;QACA,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC7B,EAAE,OAAM;QACJ,OAAO;IACX;AACJ;AAEO,SAAS,oBAAoB,UAAyB;IACzD,IAAI,CAAC,cAAc,CAAC,WAAW,UAAU,CAAC,YAAY;QAClD,OAAO;IACX;IACA,OAAO,WAAW,SAAS,CAAC;AAChC","debugId":null}},
    {"offset": {"line": 150, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/SSAFY/Desktop/panaxtos/front/app/api/reservations/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { prisma } from '@/lib/prisma';\r\nimport { getTokenFromRequest, verifyToken } from '@/lib/jwt';\r\nimport fs from 'fs';\r\nimport path from 'path';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nconst DATA_FILE_PATH = path.join(process.cwd(), 'data', 'reservations.json');\r\n\r\n// Helper to read/write JSON for local dev fallback\r\nfunction readJsonData() {\r\n    if (!fs.existsSync(DATA_FILE_PATH)) return [];\r\n    const fileData = fs.readFileSync(DATA_FILE_PATH, 'utf-8');\r\n    return JSON.parse(fileData);\r\n}\r\n\r\nfunction writeJsonData(data: any[]) {\r\n    const dir = path.dirname(DATA_FILE_PATH);\r\n    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });\r\n    fs.writeFileSync(DATA_FILE_PATH, JSON.stringify(data, null, 2));\r\n}\r\n\r\n// GET /api/reservations - 공개 (미래 예약만, 개인정보 마스킹)\r\nexport async function GET(request: NextRequest) {\r\n    try {\r\n        const { searchParams } = new URL(request.url);\r\n        const branchId = searchParams.get('branchId');\r\n        const isAdmin = searchParams.get('admin') === 'true'; // 관리자 모드 확인\r\n\r\n        // 관리자 요청인 경우 토큰 확인\r\n        if (isAdmin) {\r\n            const token = getTokenFromRequest(request.headers.get('authorization'));\r\n            if (!token || !verifyToken(token)) {\r\n                return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\r\n            }\r\n        }\r\n\r\n        let reservations;\r\n        try {\r\n            // Prisma 시도\r\n            reservations = await prisma.reservation.findMany({\r\n                where: {\r\n                    ...(branchId ? { branchId } : {}),\r\n                    // ...(isAdmin ? {} : { dateTime: { gte: new Date() } }) // 날짜 필터링 잠시 해제\r\n                },\r\n                orderBy: { dateTime: 'asc' }\r\n            });\r\n        } catch (e) {\r\n            // Prisma 실패 시 JSON 파일 폴백\r\n            console.warn('Prisma failed, falling back to JSON file');\r\n            let allData = readJsonData();\r\n            const now = new Date();\r\n            reservations = allData.filter((r: any) => {\r\n                const rDate = new Date(r.dateTime);\r\n                const branchMatch = branchId ? r.branchId === branchId : true;\r\n                // const timeMatch = isAdmin ? true : rDate >= now; // 날짜 필터링 잠시 해제\r\n                return branchMatch; // && timeMatch;\r\n            }).sort((a: any, b: any) => new Date(a.dateTime).getTime() - new Date(b.dateTime).getTime());\r\n        }\r\n\r\n        // 일반 사용자에게는 민감 정보 마스킹\r\n        if (!isAdmin) {\r\n            reservations = reservations.map((r: any) => ({\r\n                id: r.id,\r\n                branchId: r.branchId,\r\n                name: r.name.length > 1 ? r.name[0] + '*' + r.name.slice(2) : r.name, // 홍*동\r\n                dateTime: r.dateTime,\r\n                programId: r.programId,\r\n                // phone, notes, password 제외\r\n            }));\r\n        }\r\n\r\n        return NextResponse.json(reservations);\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json(\r\n            { error: 'Failed to fetch reservations' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n// POST /api/reservations - 예약 생성 (비밀번호 필수)\r\nexport async function POST(request: NextRequest) {\r\n    try {\r\n        const body = await request.json();\r\n\r\n        // 유효성 검사\r\n        if (!body.password || body.password.length < 4) {\r\n            return NextResponse.json({ error: '비밀번호는 4자리 이상이어야 합니다.' }, { status: 400 });\r\n        }\r\n\r\n        let reservation;\r\n        try {\r\n            reservation = await prisma.reservation.create({ data: body });\r\n        } catch (e) {\r\n            console.warn('Prisma failed, falling back to JSON file');\r\n            const allData = readJsonData();\r\n            const newId = allData.length > 0 ? Math.max(...allData.map((r: any) => r.id)) + 1 : 1;\r\n            reservation = { ...body, id: newId, createdAt: new Date().toISOString() };\r\n            allData.push(reservation);\r\n            writeJsonData(allData);\r\n        }\r\n\r\n        return NextResponse.json(reservation);\r\n    } catch (error) {\r\n        console.error(error);\r\n        return NextResponse.json(\r\n            { error: 'Failed to create reservation' },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}